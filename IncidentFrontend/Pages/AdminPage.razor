@page "/admin"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JS
@inject NavigationManager Navigation

<PageTitle>Administracija korisnika</PageTitle>

<div class="dark-container">
    <div class="header-section">
        <div class="header-content">
            <h3 class="page-title">
                Administracija korisnika
            </h3>
            <button class="logout-button" @onclick="Logout">
                <span>Odjavi se</span>
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p class="loading-text">Učitavanje korisnika...</p>
        </div>
    }
    else if (!users.Any())
    {
        <div class="alert-info">
            <span>Nema registrovanih korisnika</span>
        </div>
    }
    else
    {
        <div class="users-container">
            <div class="table-wrapper">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Korisničko ime</th>
                            <th>Email</th>
                            <th>Puno ime</th>
                            <th>Trenutna uloga</th>
                            <th>Promijeni ulogu</th>
                            <th>Akcije</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var user in users)
                        {
                            <tr>
                                <td>@user.Id</td>
                                <td>@user.Username</td>
                                <td>@user.Email</td>
                                <td>@user.FullName</td>
                                <td>
                                    <span class="role-badge role-@user.Role.ToLower()">
                                        @user.Role
                                    </span>
                                </td>
                                <td>
                                    <div class="radio-group">
                                        <label class="radio-label">
                                            <input type="radio"
                                                   name="role-@user.Id"
                                                   value="User"
                                                   checked="@(user.SelectedRole == "User")"
                                                   @onchange="@(() => user.SelectedRole = "User")" />
                                            <span>User</span>
                                        </label>
                                        <label class="radio-label">
                                            <input type="radio"
                                                   name="role-@user.Id"
                                                   value="Moderator"
                                                   checked="@(user.SelectedRole == "Moderator")"
                                                   @onchange="@(() => user.SelectedRole = "Moderator")" />
                                            <span>Moderator</span>
                                        </label>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-update"
                                                @onclick="() => UpdateUserRole(user.Id, user.SelectedRole)"
                                                disabled="@(isProcessing || user.Role == user.SelectedRole)">
                                            Ažuriraj
                                        </button>
                                        <button class="btn-delete"
                                                @onclick="() => DeleteUser(user.Id)"
                                                disabled="@isProcessing">
                                            Obriši
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="@(isSuccess ? "alert-success" : "alert-danger")">
            <span class="alert-icon">@(isSuccess ? "✓" : "✗")</span>
            @message
        </div>
    }
</div>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap');

    * {
        font-family: 'Open Sans', sans-serif;
    }

    .dark-container {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        padding: 2rem;
        color: #e0e0e0;
    }

    .header-section {
        margin-bottom: 2rem;
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 700;
        color: #ffffff;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .logout-button {
        padding: 0.75rem 1.5rem;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
        border-radius: 8px;
        color: #ffffff;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        font-family: 'Open Sans', sans-serif;
    }

        .logout-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .logout-button:active {
            transform: translateY(0);
        }

    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 4rem 2rem;
        background: rgba(30, 30, 50, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 2rem;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(74, 158, 255, 0.2);
        border-top-color: #4a9eff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .loading-text {
        margin-top: 1.5rem;
        color: #b8c5d6;
        font-size: 1.1rem;
    }

    .alert-info {
        padding: 1.5rem 2rem;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        border-radius: 12px;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        margin-bottom: 2rem;
        font-size: 1.1rem;
    }

    .users-container {
        background: rgba(30, 30, 50, 0.8);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        margin-bottom: 2rem;
    }

    .table-wrapper {
        overflow-x: auto;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
    }

        .users-table thead {
            background: rgba(20, 20, 35, 0.9);
        }

        .users-table th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #b8c5d6;
            border-bottom: 2px solid #2d3561;
            font-size: 0.95rem;
        }

        .users-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(45, 53, 97, 0.5);
            color: #e0e0e0;
        }

        .users-table tbody tr {
            transition: background-color 0.2s ease;
        }

            .users-table tbody tr:hover {
                background: rgba(20, 20, 35, 0.5);
            }

    .role-badge {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .role-admin {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: #ffffff;
    }

    .role-moderator {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: #ffffff;
    }

    .role-user {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: #ffffff;
    }

    .radio-group {
        display: flex;
        gap: 1rem;
    }

    .radio-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-size: 0.95rem;
    }

        .radio-label input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #4a9eff;
        }

        .radio-label span {
            color: #e0e0e0;
        }

        .radio-label:hover span {
            color: #ffffff;
        }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-update, .btn-delete {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        color: #ffffff;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Open Sans', sans-serif;
    }

    .btn-update {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

        .btn-update:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-update:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    .btn-delete {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

        .btn-delete:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-update:active:not(:disabled),
        .btn-delete:active:not(:disabled) {
            transform: translateY(0);
        }

    .alert-success {
        margin-top: 1.5rem;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 8px;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        animation: slideIn 0.3s ease;
        font-size: 1.05rem;
    }

    .alert-danger {
        margin-top: 1.5rem;
        padding: 1rem 1.5rem;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-radius: 8px;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        animation: slideIn 0.3s ease;
        font-size: 1.05rem;
    }

    .alert-icon {
        font-size: 1.5rem;
        font-weight: bold;
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@media (max-width: 1024px) {
        .table-wrapper {
            overflow-x: scroll;
        }

        .users-table {
            min-width: 800px;
        }
    }

    @@media (max-width: 768px) {
        .dark-container {
            padding: 1rem;
        }

        .header-content {
            flex-direction: column;
            align-items: flex-start;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .logout-button {
            width: 100%;
        }

        .users-container {
            padding: 1rem;
        }

        .action-buttons {
            flex-direction: column;
            gap: 0.25rem;
        }

        .btn-update, .btn-delete {
            width: 100%;
        }
    }
</style>

@code {
    private HttpClient _http = default!;

    private List<UserInfo> users = new();
    private bool isLoading = true;
    private bool isProcessing = false;
    private string message = "";
    private bool isSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        _http = HttpClientFactory.CreateClient("AuthenticatedClient");
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        message = "";
        StateHasChanged();

        try
        {
            var response = await _http.GetAsync("/api/auth/users");

            if (response.IsSuccessStatusCode)
            {
                users = await response.Content.ReadFromJsonAsync<List<UserInfo>>() ?? new();

                // Postavi SelectedRole na trenutnu ulogu korisnika
                foreach (var user in users)
                {
                    user.SelectedRole = user.Role;
                }
            }
            else
            {
                message = "Greška pri učitavanju korisnika.";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"Greška: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task UpdateUserRole(string userId, string newRole)
    {
        isProcessing = true;
        message = "";
        StateHasChanged();

        try
        {
            var response = await _http.PutAsJsonAsync($"/api/auth/users/{userId}/role", new { Role = newRole });

            if (response.IsSuccessStatusCode)
            {
                message = $"Uloga korisnika uspješno ažurirana na {newRole}!";
                isSuccess = true;
                await LoadUsers();
            }
            else
            {
                message = "Greška pri ažuriranju uloge korisnika.";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"Greška: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DeleteUser(string userId)
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Da li ste sigurni da želite obrisati ovog korisnika?"))
            return;

        isProcessing = true;
        message = "";
        StateHasChanged();

        try
        {
            var response = await _http.DeleteAsync($"/api/auth/users/{userId}");

            if (response.IsSuccessStatusCode)
            {
                message = "Korisnik uspješno obrisan!";
                isSuccess = true;
                await LoadUsers();
            }
            else
            {
                message = "Greška pri brisanju korisnika.";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"Greška: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task Logout()
    {
        await JS.InvokeVoidAsync("localStorage.removeItem", "authToken");
        Navigation.NavigateTo("/login", true);
    }

    public class UserInfo
    {
        public string Id { get; set; } = "";
        public string Username { get; set; } = "";
        public string Email { get; set; } = "";
        public string FullName { get; set; } = "";
        public string Role { get; set; } = "";
        public string SelectedRole { get; set; } = "";
    }
}